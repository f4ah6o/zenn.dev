# 1password-cli`op`の不便さを解消するCLIラッパー`opz`を作った

1Password CLIの`op`コマンドを使うと、1Passwordに保存しているシークレットを環境変数としてそのまま利用できます。
パスワードやAPIトークンを平文で保存せず、セキュリティ的に安心です。

ですが、実際に使ってみて不便さを感じ、CLIラッパーの`opz`を作りました。

@[card](https://github.com/f4ah6o/opz)

## `op run`のつらさ

1. 毎回`.env`を作成するのが面倒
2. 環境変数名を覚えられない
3. `op://foo/bar/baz`という参照パスが長くて覚えられない。特に日本語で項目名を保存するとIDが含まれるので、毎回コピペが必要
4. `op run --env-file foo -- bar`というコマンドが長く、タイプするのが大変

## `opz`のゴール

### 1. 無駄なくコマンドを実行したい

```bash
opz foo -- bar
```

項目名とコマンドを指定するだけ。覚えることも少なく、サッと実行できます。

### 2. `.env`も簡単に作りたい

```bash
opz gen foo [.env]
```

ファイルだけ作りたい時もサクッと対応できます。

* 本当は`opx`という名前にしたかったのですが、既に存在していたので`opz`にしました

## 覚えること/覚えられること

* `foo`: 1Passwordに登録した項目名
* `bar`: 実行したいコマンド

これだけ覚えればOK。前述の`op run`のつらさは全部解消されます。

## 1Passwordでの設定

1. 各フィールドのラベルに環境変数名を入力する（例: `API_KEY`）
2. シークレット以外の情報も登録する（例: APIのURLなど）
3. アイテム名は覚えやすいものにする（日本語OK）

## 使い方

* `op`が使える状態であることが前提です

### インストール

```bash
cargo install opz
```

### 基本形

```bash
# 項目名を指定してコマンドを実行
opz foo -- bar
# opz run foo -- bar  # 同じ意味
```

```bash
# 出力先の.envファイルを指定
opz foo .env.production -- bar
```

### サブコマンド

```bash
# 項目をキーワード検索
opz find api

# .envファイルのみ生成
opz gen foo .env
```

## 動作フロー

コマンド実行時の内部処理は以下の通りです。

1. `op item list`で項目一覧を取得し、指定した項目名を検索
2. `op item get`で項目のフィールド情報を取得し、`op://`形式で参照文字列を構築
3. 環境変数をインラインで直接代入する時に`op read`を使用してコマンドを実行
  * 本当は`op run --env-file`を使いたかったが、Claudeで起動に失敗するため断念
